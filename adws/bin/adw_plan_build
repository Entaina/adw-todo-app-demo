#!/usr/bin/env ruby
# frozen_string_literal: true

#
# ADW Plan & Build - AI Developer Workflow (ADW)
#
# Usage: adw_plan_build <github-issue-number> [adw-id]
#
# Workflow:
# 1. Fetch GitHub issue details
# 2. Classify issue (chore, bug, feature)
# 3. Create feature branch
# 4. Plan Agent: Generate implementation plan
# 5. Commit plan
# 6. Build Agent: Implement the solution
# 7. Commit implementation
# 8. Create PR with full context
#

require "bundler/setup"
require "dotenv/load"
require_relative "../lib/adw"

# Agent name constants
AGENT_PLANNER = "sdlc_planner"
AGENT_IMPLEMENTOR = "sdlc_implementor"
AGENT_CLASSIFIER = "issue_classifier"
AGENT_PLAN_FINDER = "plan_finder"
AGENT_BRANCH_GENERATOR = "branch_generator"
AGENT_PR_CREATOR = "pr_creator"

def parse_args
  if ARGV.length < 1
    puts "Usage: adw_plan_build <issue-number> [adw-id]"
    puts "Example: adw_plan_build 123"
    puts "Example: adw_plan_build 123 abc12345"
    exit 1
  end

  issue_number = ARGV[0]
  adw_id = ARGV[1]

  [issue_number, adw_id]
end

def format_issue_message(adw_id, agent_name, message, session_id = nil)
  if session_id
    "#{adw_id}_#{agent_name}_#{session_id}: #{message}"
  else
    "#{adw_id}_#{agent_name}: #{message}"
  end
end

def classify_issue(issue, adw_id, logger)
  request = Adw::AgentTemplateRequest.new(
    agent_name: AGENT_CLASSIFIER,
    slash_command: "/adw:classify_issue",
    args: [issue.to_json],
    adw_id: adw_id,
    model: "sonnet"
  )

  logger.debug("issue_template_request: #{request.to_h}")

  response = Adw::Agent.execute_template(request)

  logger.debug("issue_response: #{response.to_h}")

  unless response.success
    return [nil, response.output]
  end

  issue_command = response.output.strip

  if issue_command == "none"
    return [nil, "No command selected: #{response.output}"]
  end

  unless Adw::ISSUE_CLASS_COMMANDS.include?(issue_command)
    return [nil, "Invalid command selected: #{response.output}"]
  end

  [issue_command, nil]
end

def build_plan(issue, command, adw_id, logger)
  request = Adw::AgentTemplateRequest.new(
    agent_name: AGENT_PLANNER,
    slash_command: command,
    args: ["#{issue.title}: #{issue.body}"],
    adw_id: adw_id,
    model: "sonnet"
  )

  logger.debug("issue_plan_template_request: #{request.to_h}")

  response = Adw::Agent.execute_template(request)

  logger.debug("issue_plan_response: #{response.to_h}")

  response
end

def get_plan_file(plan_output, adw_id, logger)
  request = Adw::AgentTemplateRequest.new(
    agent_name: AGENT_PLAN_FINDER,
    slash_command: "/adw:find_plan_file",
    args: [plan_output],
    adw_id: adw_id,
    model: "sonnet"
  )

  response = Adw::Agent.execute_template(request)

  unless response.success
    return [nil, response.output]
  end

  file_path = response.output.strip

  if file_path && file_path != "none" && file_path.include?("/")
    [file_path, nil]
  elsif file_path == "none"
    [nil, "No plan file found in output"]
  else
    [nil, "Invalid file path response: #{file_path}"]
  end
end

def implement_plan(plan_file, adw_id, logger)
  request = Adw::AgentTemplateRequest.new(
    agent_name: AGENT_IMPLEMENTOR,
    slash_command: "/implement",
    args: [plan_file],
    adw_id: adw_id,
    model: "sonnet"
  )

  logger.debug("implement_template_request: #{request.to_h}")

  response = Adw::Agent.execute_template(request)

  logger.debug("implement_response: #{response.to_h}")

  response
end

def git_branch(issue, issue_class, adw_id, logger)
  issue_type = issue_class.delete_prefix("/")

  request = Adw::AgentTemplateRequest.new(
    agent_name: AGENT_BRANCH_GENERATOR,
    slash_command: "/adw:generate_branch_name",
    args: [issue_type, adw_id, issue.to_json],
    adw_id: adw_id,
    model: "sonnet"
  )

  response = Adw::Agent.execute_template(request)

  unless response.success
    return [nil, response.output]
  end

  branch_name = response.output.strip
  logger.info("Created branch: #{branch_name}")
  [branch_name, nil]
end

def git_commit(agent_name, issue, issue_class, adw_id, logger)
  issue_type = issue_class.delete_prefix("/")
  unique_agent_name = "#{agent_name}_committer"

  request = Adw::AgentTemplateRequest.new(
    agent_name: unique_agent_name,
    slash_command: "/git:commit",
    args: ["-m", "\"#{agent_name}: #{issue_type}: implement plan for ##{issue.number}\""],
    adw_id: adw_id,
    model: "sonnet"
  )

  response = Adw::Agent.execute_template(request)

  unless response.success
    return [nil, response.output]
  end

  commit_message = response.output.strip
  logger.info("Created commit: #{commit_message}")
  [commit_message, nil]
end

def pull_request(branch_name, issue, plan_file, adw_id, logger)
  request = Adw::AgentTemplateRequest.new(
    agent_name: AGENT_PR_CREATOR,
    slash_command: "/adw:pull_request",
    args: [branch_name, issue.to_json, plan_file, adw_id],
    adw_id: adw_id,
    model: "sonnet"
  )

  response = Adw::Agent.execute_template(request)

  unless response.success
    return [nil, response.output]
  end

  pr_url = response.output.strip
  logger.info("Created pull request: #{pr_url}")
  [pr_url, nil]
end

def check_error(error_or_response, issue_number, adw_id, agent_name, error_prefix, logger)
  error = nil

  if error_or_response.is_a?(Adw::AgentPromptResponse)
    error = error_or_response.output unless error_or_response.success
  else
    error = error_or_response
  end

  return unless error

  logger.error("#{error_prefix}: #{error}")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, agent_name, "#{error_prefix}: #{error}")
  )
  exit 1
end

def main
  # Parse arguments
  issue_number, adw_id = parse_args

  # Generate ADW ID if not provided
  adw_id ||= Adw::Utils.make_adw_id

  # Set up logger
  logger = Adw::Utils.setup_logger(adw_id, "adw_plan_build")
  logger.info("ADW ID: #{adw_id}")

  # Get repo information
  begin
    github_repo_url = Adw::GitHub.repo_url
    repo_path = Adw::GitHub.extract_repo_path(github_repo_url)
  rescue => e
    logger.error("Error getting repository URL: #{e}")
    exit 1
  end

  # Fetch and display issue
  issue = Adw::GitHub.fetch_issue(issue_number, repo_path)

  logger.debug("issue: #{issue.to_json}")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, "ops", "Starting ADW workflow")
  )

  # Classify the issue
  issue_command, error = classify_issue(issue, adw_id, logger)
  check_error(error, issue_number, adw_id, "ops", "Error classifying issue", logger)

  logger.info("issue_command: #{issue_command}")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, "ops", "Issue classified as: #{issue_command}")
  )

  # Create git branch
  branch_name, error = git_branch(issue, issue_command, adw_id, logger)
  check_error(error, issue_number, adw_id, "ops", "Error creating branch", logger)

  logger.info("Working on branch: #{branch_name}")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, "ops", "Working on branch: #{branch_name}")
  )

  # Build the implementation plan
  logger.info("\n=== Building implementation plan ===")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, AGENT_PLANNER, "Building implementation plan")
  )

  issue_plan_response = build_plan(issue, issue_command, adw_id, logger)
  check_error(issue_plan_response, issue_number, adw_id, AGENT_PLANNER, "Error building plan", logger)

  logger.debug("issue_plan_response.output: #{issue_plan_response.output}")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, AGENT_PLANNER, "Implementation plan created")
  )

  # Get the path to the plan file
  logger.info("\n=== Finding plan file ===")

  plan_file_path, error = get_plan_file(issue_plan_response.output, adw_id, logger)
  check_error(error, issue_number, adw_id, "ops", "Error finding plan file", logger)

  logger.info("plan_file_path: #{plan_file_path}")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, "ops", "Plan file created: #{plan_file_path}")
  )

  # Commit the plan
  logger.info("\n=== Committing plan ===")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, AGENT_PLANNER, "Committing plan")
  )
  commit_msg, error = git_commit(AGENT_PLANNER, issue, issue_command, adw_id, logger)
  check_error(error, issue_number, adw_id, AGENT_PLANNER, "Error committing plan", logger)

  # Implement the plan
  logger.info("\n=== Implementing solution ===")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, AGENT_IMPLEMENTOR, "Implementing solution")
  )
  implement_response = implement_plan(plan_file_path, adw_id, logger)
  check_error(implement_response, issue_number, adw_id, AGENT_IMPLEMENTOR, "Error implementing solution", logger)

  logger.debug("implement_response.output: #{implement_response.output}")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, AGENT_IMPLEMENTOR, "Solution implemented")
  )

  # Commit the implementation
  logger.info("\n=== Committing implementation ===")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, AGENT_IMPLEMENTOR, "Committing implementation")
  )
  commit_msg, error = git_commit(AGENT_IMPLEMENTOR, issue, issue_command, adw_id, logger)
  check_error(error, issue_number, adw_id, AGENT_IMPLEMENTOR, "Error committing implementation", logger)

  # Create pull request
  logger.info("\n=== Creating pull request ===")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, "ops", "Creating pull request")
  )

  pr_url, error = pull_request(branch_name, issue, plan_file_path, adw_id, logger)
  check_error(error, issue_number, adw_id, "ops", "Error creating pull request", logger)

  logger.info("\nPull request created: #{pr_url}")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, "ops", "Pull request created: #{pr_url}")
  )

  logger.info("ADW workflow completed successfully for issue ##{issue_number}")
  Adw::GitHub.make_issue_comment(
    issue_number,
    format_issue_message(adw_id, "ops", "ADW workflow completed successfully")
  )
end

main
